{% extends "seller/main.html" %}
{% load static %}
{% block title %} SellerChat {% endblock title %}
{% block seller_page_title %} Seller Chat {% endblock seller_page_title %}

{% block seller_content %}
            <!-- Audio files for sounds -->
    <audio id="new-message-sound" src="{% static 'mp3/receive_message.mp3' %}"></audio>
    <audio id="send-message-sound" src="{% static 'mp3/send_message.mp3' %}"></audio>
        <!-- content begin -->
        <div class="col-lg-9">
            <div class="card p-4 rounded-5 mb25">
                <h4>Chat with {{ other_user.username }}</h4>
                <div class="chat-container" style="height: 400px; display: flex; flex-direction: column;">
                    <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3" style="background-color: #f8f9fa; border-radius: 10px; padding: 15px;">
                        <!-- Messages will be dynamically loaded here -->
                    </div>
                    <div class="input-group">
                        <textarea class="form-control" id="message-input" placeholder="Type your message..." rows="2"></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="send-message">
                                <i class="fa fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                const conversationId = '{{ conversation_id }}';
    const sendMessageUrl = '{% url "send_message" %}';
    const fetchMessagesUrl = '{% url "fetch_messages" %}';
    const chatMessagesDiv = document.getElementById('chat-messages');
    const currentUserId = '{{ request.user.id }}';
    const authToken = '{{ request.user.auth_token.key }}';
    const newMessageSound = document.getElementById('new-message-sound');
    const sendMessageSound = document.getElementById('send-message-sound');
    let lastMessageId = null;

    // Function to play sound and catch any errors
    function playSound(audioElement) {
        audioElement.play().catch(function(error) {
            console.error('Audio playback failed:', error);
        });
    }

    // Create chat message elements
    function createMessageElement(message) {
        const isSender = message.sender === parseInt(currentUserId);
        const messageElem = document.createElement('div');
        messageElem.className = `d-flex ${isSender ? 'justify-content-end' : 'justify-content-start'} mb-3`;
        messageElem.innerHTML = `
            <div class="d-flex ${isSender ? 'flex-row-reverse' : 'flex-row'} align-items-end" style="max-width: 75%;">
                <img src="${message.sender_profile_picture}" alt="Profile Picture" class="rounded-circle mr-2" 
                     style="width: 30px; height: 30px; ${isSender ? 'margin-left: 10px;' : 'margin-right: 10px;'}">
                <div class="message-content p-2 rounded" style="background-color: ${isSender ? '#007bff' : '#e9ecef'}; color: ${isSender ? 'white' : 'black'};">
                    ${message.content}
                </div>
            </div>
        `;
        return messageElem;
    }

    // Fetch messages from server
    function fetchMessages() {
        $.ajax({
            url: `${fetchMessagesUrl}?conversation_id=${conversationId}`,
            headers: {
                'Authorization': `Token ${authToken}`
            },
            success: function(data) {
                const isNewMessage = data.length && (!lastMessageId || data[data.length - 1].id !== lastMessageId);
                chatMessagesDiv.innerHTML = '';
                data.forEach(message => {
                    chatMessagesDiv.appendChild(createMessageElement(message));
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

                // Play sound if there is a new message
                if (isNewMessage) {
                    console.log("New message received, playing sound...");
                    playSound(newMessageSound);
                    lastMessageId = data[data.length - 1].id;
                }
            },
            error: function(xhr, status, error) {
                console.error("Error fetching messages:", error);
            }
        });
    }

    // Send message and play sound on success
    $('#send-message').on('click', function() {
        const messageContent = $('#message-input').val().trim();
        if (!messageContent) return;

        $.ajax({
            url: sendMessageUrl,
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Token ${authToken}`
            },
            data: JSON.stringify({
                conversation_id: conversationId,
                content: messageContent
            }),
            success: function() {
                $('#message-input').val('');
                console.log("Message sent, playing sound...");
                playSound(sendMessageSound);  // Play sound for sending message
                fetchMessages();
            },
            error: function(xhr, status, error) {
                console.error("Error sending message:", error);
            }
        });
    });

    // Send message on pressing Enter (without Shift)
    $('#message-input').on('keypress', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            $('#send-message').click();
        }
    });

    // Fetch messages every 3 seconds
    setInterval(fetchMessages, 3000);

    // Initial fetch
    fetchMessages();
            </script>
{% endblock %}